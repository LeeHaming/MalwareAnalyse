#!/usr/bin/env python
#encoding:utf-8
"""
MalwareAnalyse\permission
written by leeham
"""

import os
import sys
import zipfile
import re

pathAPK="E:\MalwareAnalyse\APK\\"
pathPermFile="./Permfiles/"
def getAppBaseInfo(apkName):

	output=os.popen("aapt d badging %s" % apkName).read()
	#print(output)
	match = re.compile("package: name='(\S+)' versionCode='(\d+)' versionName='(\S+)' platformBuildVersionName='\S*'").match(output)  
	if not match:
		raise Exception("cannot get packageinfo")

	packagename=match.group(1)
	versionCode=match.group(2)
	versionName=match.group(3)

	print('packagename:'+packagename)
	print('versionCode:'+versionCode)
	print('versionName:'+versionName)

	outfile=os.path.splitext(filename)[-2]
	print("outfilename:"+outfile)
	permissionFile=pathPermFile+outfile+".txt"
	f=open(permissionFile,"w+")

	outList=output.split('\n')
	for line in outList:
		if line.startswith('uses-permission:'):
			#print(line)
			#print((line.split('.')[-1]).split('\'')[0])
			f.write((line.split('.')[-1]).split('\'')[0]+'\n')
	f.close()

if __name__ == '__main__':
	for dir in os.walk(pathAPK):
		print(dir[0])
		
		for filename in dir[2]:
			if os.path.splitext(filename)[-1]=='.apk':
				print('find apk:',filename)
				apkName=os.path.join(dir[0],filename)
				print('find apk:',apkName)
				#这里的异常处理无法处理invalid error 
				#不知道那个属于什么error类型
				try:
					getAppBaseInfo(apkName)
				except UnicodeDecodeError:
					print(apkName+'file is interrupted for ---UnicodeDecodeError')
					continue
				except AttributeError:
					print(apkName+'file is interrupted for ---AttributeError')
					continue	
				except Exception:
					print(apkName+'file is interrupted for ---Exception')
					continue				
				else:
					print(apkName+'file is finished')
				