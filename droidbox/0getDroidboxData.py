#encoding='utf-8'

import sys
import subprocess
import os

from os.path import join as join_dir


def get_call_DroidBox(apk_path):
	droidbox_call_list = ["/home/android/droid/DroidBox_4.1.1/droidbox.sh",apk_path,"50"]
	return " ".join(droidbox_call_list)





def run_DroidBox(input_dir,output_dir):
	
	if not os.path.exists(input_dir):
        	print print_message("Folder not found!", with_color, 'red')
	if not os.path.exists(output_dir):
		os.makedirs(output_dir)
	
	list_apks = []
	for path, subdirs, files in os.walk(input_dir):
		for name in files:
			if name.endswith(".apk"):
				list_apks.append(os.path.join(path, name))


	for apk_path in list_apks:

		apk_id = os.path.basename(apk_path)
		print "RUNNING FLOWDROID FOR: " + str(apk_id)
		
		#if os.path.isfile(join_dir(output_dir, apk_id.replace(".apk", ".json"))) in apk_id:
		#	continue
		print "TRUE TRUE TRUE"
		droidbox_call = get_call_DroidBox(apk_path)
		print droidbox_call
	
		

		origen_wd = os.getcwd()
		#change directory
		os.chdir("/home/android/droid/DroidBox_4.1.1")
		print os.getcwd()

		process = subprocess.Popen(droidbox_call, shell=True, stdout=subprocess.PIPE,stderr=subprocess.STDOUT)
		
		#--------command to execute DroidBox---------
		#process = subprocess.Popen(droidbox_call, shell=True, stdout=subprocess.PIPE,stderr=subprocess.STDOUT)
		#stdout, stderr = process.communicate()
		# , env={'PATH': FLOWDROID_FOLDER})

		os.chdir(origen_wd)  # get back to our original working directory
		stdout, stderr = process.communicate()
		#no need for timer		
		#timer = Timer(MAX_TIME_ANALYSIS * 60, kill, [process])
		#try:
		#    timer.start()
		#    stdout, stderr = process.communicate()

		#finally:
		#    timer.cancel()

		with open(join_dir(output_dir, apk_id.replace(".apk", ".json")), "w") as output:
			output.write(str(stdout))
			print str(stdout)
			output.write(str(stderr))
			print str(stderr)
def main():
	run_DroidBox("/home/android/droid/src/apks/","/home/android/droid/des/")

if __name__ == '__main__':
	main()


